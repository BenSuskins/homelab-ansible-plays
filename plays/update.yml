---
- name: UPDATE - Update and upgrade host
  hosts: all
  become: true
  become_method: ansible.builtin.su
  vars_files:
    - "~/.ansible/vault.yml"

  tasks:
    - name: UPDATE - Update packages
      ansible.builtin.apt:
        update_cache: true
      register: apt_update_res

    - name: UPDATE - Upgrade packages
      ansible.builtin.apt:
        upgrade: dist
      register: apt_upgrade_res

    - name: UPDATE - Update firewall
      ansible.builtin.include_tasks:
        file: "../tasks/other/firewall.yml"
      register: firewall_results
      when: firewall|bool

    - name: UPDATE - Gather Docker container facts
      community.docker.docker_host_info:
      register: docker_info

    - name: UPDATE - Set docker_container_names list
      ansible.builtin.set_fact:
        docker_container_names: "{{ docker_info.containers | default([]) | map(attribute='Names') | map('first') | map('regex_replace','^/','') | list }}"

    - name: UPDATE - Stop all running containers
      community.docker.docker_container:
        name: "{{ item }}"
        state: stopped
      loop: "{{ docker_container_names | default([]) }}"
      when: docker_container_names | default([]) | length > 0
      register: stop_results

    - name: UPDATE - Update Core Docker Containers
      ansible.builtin.include_tasks:
        file: "../tasks/docker/{{ item }}.yml"
      loop: "{{ core_containers | default([]) }}"
      register: core_results

    - name: UPDATE - Update Docker Containers
      ansible.builtin.include_tasks:
        file: "../tasks/docker/{{ item }}.yml"
      loop: "{{ containers | default([]) }}"
      register: containers_results

    - name: UPDATE - Remove stopped containers not wanted
      community.docker.docker_container:
        name: "{{ item }}"
        state: absent
      loop: "{{ docker_container_names | default([]) }}"
      when: item not in (containers | default([]) + core_containers | default([]))
      register: remove_results

    - name: UPDATE - Update Traefik
      when: ansible_hostname == 'development'
      ansible.builtin.include_tasks:
        file: "../tasks/docker/traefik.yml"
      register: traefik_results

    - name: UPDATE - Update Gatus
      when: ansible_hostname == 'monitor'
      ansible.builtin.include_tasks:
        file: "../tasks/docker/gatus.yml"
      register: gatus_results

    - name: UPDATE - Update Homepage
      when: ansible_hostname == 'docker'
      ansible.builtin.include_tasks:
        file: "../tasks/docker/homepage.yml"
      register: homepage_results

    - name: UPDATE - Update Prometheus
      when: ansible_hostname == 'monitor'
      ansible.builtin.include_tasks:
        file: "../tasks/docker/prometheus.yml"
      register: prometheus_results

    - name: UPDATE - Set reboot_required if important tasks changed
      ansible.builtin.set_fact:
        reboot_required: true
      when: >
        (apt_update_res is defined and (apt_update_res.changed | default(false))) or
        (apt_upgrade_res is defined and (apt_upgrade_res.changed | default(false))) or
        (firewall_results is defined and (firewall_results.changed | default(false))) or
        (stop_results is defined and (stop_results.changed | default(false))) or
        (core_results is defined and (core_results.changed | default(false))) or
        (containers_results is defined and (containers_results.changed | default(false))) or
        (remove_results is defined and (remove_results.changed | default(false))) or
        (traefik_results is defined and (traefik_results.changed | default(false))) or
        (gatus_results is defined and (gatus_results.changed | default(false))) or
        (homepage_results is defined and (homepage_results.changed | default(false))) or
        (prometheus_results is defined and (prometheus_results.changed | default(false)))

    - name: UPDATE - Reboot server
      ansible.builtin.reboot:
        msg: "Rebooting server after update"
      when: reboot_required | default(false)
