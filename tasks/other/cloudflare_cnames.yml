---
- name: CLOUDFLARE - Aggregate services from all hosts
  ansible.builtin.include_tasks:
    file: "../tasks/core/aggregate_services.yml"

- name: CLOUDFLARE - Ensure CNAMEs for exposed services
  vars:
    services: "{{ (static_services | default([])) + (all_docker_services | default([])) }}"
  loop: "{{ services }}"
  loop_control:
    loop_var: svc
  when: "svc.exposed | default(false)"

  community.general.cloudflare_dns:
    zone: "suskins.co.uk"
    value: "{{ svc.host | default(svc.name ~ '.suskins.co.uk') }}"
    type: CNAME
    proxied: true
    state: present
    api_token: "{{ CLOUDFLARE_API_TOKEN }}"
  delegate_to: localhost
