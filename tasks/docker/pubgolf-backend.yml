---
- name: PUBGOLF-BACKEND - Create container
  community.docker.docker_container:
    name: pubgolf-backend
    image: ghcr.io/bensuskins/pubgolf-backend:06d68fa
    restart_policy: always
    state: started
    pull: true
    networks:
      - name: homelab
    ports:
      - "8080:8080"
    env:
      SPRING_PROFILES_ACTIVE: "prod"
      DB_HOST: "pubgolf-postgres"
      DB_USERNAME: "{{ DB_USERNAME }}"
      DB_PASSWORD: "{{ DB_PASSWORD }}"
      DB_PORT: "5432"

- name: PUBGOLF-BACKEND - Define service entry
  ansible.builtin.set_fact:
    pubgolf_backend_entry:
      name: pubgolf-backend
      ip: "{{ inventory_hostname }}"
      friendly_name: "{{ friendly_name }}"
      port: 8080
      scheme: http
      secured: false
      hidden: true
      metrics_enabled: true
      metrics_port: 8080
      metrics_path: /actuator/prometheus
      metrics_interval: 60s

- name: PUBGOLF-BACKEND - Append to docker_services
  ansible.builtin.set_fact:
    docker_services: "{{ docker_services + [pubgolf_backend_entry] }}"
