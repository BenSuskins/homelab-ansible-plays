domain: suskins.co.uk
mediaserver_ip: 192.168.0.101
docker_ip: 192.168.0.102
monitor_ip: 192.168.0.104
nas_ip: 192.168.0.100
timezone: Europe/London
mount_nas: false
firewall: false
docker_services: []
username: "{{ ansible_user }}"
puid: 1000
pgid: 1000
journal_vacuum_time: 30d

packages:
  - wget
  - curl
  - git
  - qemu-guest-agent
  - sudo
  - ufw
  - nfs-common

docker_dependencies:
  - ca-certificates
  - gnupg
  - curl

docker_packages:
  - docker-ce
  - docker-ce-cli
  - containerd.io
  - docker-compose-plugin

core_containers:
  - alloy

core_container_definitions:
  alloy:
    container_name: alloy
    container_image: grafana/alloy:v1.12.1
    container_dirs:
      - "{{ base_dir }}/alloy/config"
    container_command: run /etc/alloy/config/config.alloy
    container_volumes:
      - "{{ base_dir }}/alloy/config:/etc/alloy/config"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "/:/rootfs:ro"
      - "/var/run:/var/run:ro"
      - "/sys:/host/sys:ro"
      - "/proc:/host/proc:ro"
      - "/var/lib/docker/:/var/lib/docker:ro"
      - "/dev/disk/:/dev/disk:ro"
    container_config_files:
      - dest: "{{ base_dir }}/alloy/config/config.alloy"
        content: |
          // Logging configuration
          logging {
            level  = "info"
            format = "logfmt"
          }

          // Docker log collection
          discovery.docker "log_scrape" {
            host             = "unix:///var/run/docker.sock"
            refresh_interval = "5s"
          }

          discovery.relabel "log_scrape" {
            targets = []

            rule {
              source_labels = ["__meta_docker_container_name"]
              regex         = "/(.*)"
              target_label  = "container"
            }

            rule {
              source_labels = ["__meta_docker_container_log_stream"]
              target_label  = "logstream"
            }

            rule {
              source_labels = ["__meta_docker_container_label_logging_jobname"]
              target_label  = "job"
            }
          }

          loki.source.docker "log_scrape" {
            host             = "unix:///var/run/docker.sock"
            targets          = discovery.docker.log_scrape.targets
            forward_to       = [loki.write.default.receiver]
            relabel_rules    = discovery.relabel.log_scrape.rules
            refresh_interval = "5s"
          }

          loki.write "default" {
            endpoint {
              url = "http://{{ monitor_ip }}:3100/loki/api/v1/push"
            }
            external_labels = {}
          }

          // Container metrics (replaces cadvisor)
          prometheus.exporter.cadvisor "containers" {
            docker_host      = "unix:///var/run/docker.sock"
            storage_duration = "5m"
          }

          prometheus.scrape "cadvisor" {
            targets         = prometheus.exporter.cadvisor.containers.targets
            forward_to      = [prometheus.remote_write.default.receiver]
            scrape_interval = "60s"
          }

          // Host metrics (replaces node_exporter)
          prometheus.exporter.unix "host" {
            procfs_path = "/host/proc"
            sysfs_path  = "/host/sys"
            rootfs_path = "/rootfs"
          }

          prometheus.scrape "unix" {
            targets         = prometheus.exporter.unix.host.targets
            forward_to      = [prometheus.remote_write.default.receiver]
            scrape_interval = "60s"
          }

          prometheus.remote_write "default" {
            endpoint {
              url = "http://{{ monitor_ip }}:9090/api/v1/write"
            }
          }
    register_service: false

static_services:
  # Bolsters
  - name: home
    host: "home.{{ domain }}"
    ip: 192.168.0.102
    friendly_name: Docker
    port: 3000
    scheme: http
    secured: true
    proxied: true

  - name: gatus
    ip: 192.168.0.104
    host: "gatus.{{ domain }}"
    friendly_name: Monitoring
    port: 8080
    scheme: http
    secured: true
    proxied: true
    homepage: true

  # Proxmox
  - name: proxmox
    host: "pve.{{ domain }}"
    ip: 192.168.0.253
    friendly_name: General
    port: 8006
    scheme: https
    secured: false
    healthcheck: true
    homepage: true
    proxied: true

  # Unifi
  - name: unifi
    host: "unifi.{{ domain }}"
    ip: 192.168.0.1
    friendly_name: General
    port: 443
    scheme: https
    middleware: unifi-headers
    secured: false
    healthcheck: true
    homepage: true
    proxied: true

  # NAS
  - name: truenas
    host: "nas.{{ domain }}"
    ip: 192.168.0.100
    friendly_name: General
    port: 443
    scheme: https
    secured: false
    healthcheck: true
    homepage: true
    proxied: true

  # Home Assistant
  - name: homeassistant
    host: "homeassistant.{{ domain }}"
    ip: 192.168.0.65
    friendly_name: General
    port: 8123
    scheme: http
    secured: false
    healthcheck: true
    homepage: true
    proxied: true

  # Games
  - name: games
    host: "games.{{ domain }}"
    ip: 192.168.0.202
    friendly_name: Games
    port: 80
    scheme: http
    healthcheck: true
    secured: true
    homepage: true
    proxied: true

  - name: starscream
    host: "starscream.{{ domain }}"
    ip: 192.168.0.125
    friendly_name: Games
    port: 8080
    scheme: http
    secured: false
    proxied: true

  - name: minecraft
    host: "minecraft.{{ domain }}"
    ip: 192.168.0.125
    friendly_name: Games
    port: 25566
    scheme: http
    healthcheck: true
    secured: true
    homepage: true
    proxied: true
